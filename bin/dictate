#!/usr/bin/env bash
# Local speech-to-text using WhisperKit on Apple Silicon
# See: https://github.com/ansonhoyt/dotfiles/issues/1

set -euo pipefail

# Config
MODEL="openai_whisper-large-v3-turbo"
CACHE_DIR="${HOME}/.cache/dictate"
SAMPLE_RATE=16000
MIN_DURATION=0.5

# Exit codes
EXIT_SUCCESS=0
EXIT_NOT_READY=1
EXIT_RECORDING_FAILED=2
EXIT_TRANSCRIPTION_FAILED=3

usage() {
  cat <<EOF
Usage: dictate [OPTIONS]

Local speech-to-text using WhisperKit.

Options:
  --setup    Check deps, download model (interactive)
  --check    Quick deps check (exit 0 if ready, 1 if not)
  --help     Show this help

Without options: record from mic, transcribe, output to stdout.
EOF
}

check_deps() {
  local missing=()
  command -v whisperkit-cli &>/dev/null || missing+=("whisperkit-cli")
  command -v sox &>/dev/null || missing+=("sox")

  if [[ ${#missing[@]} -gt 0 ]]; then
    echo "Missing: ${missing[*]}" >&2
    echo "Run: brew bundle --global" >&2
    return 1
  fi
  return 0
}

check_model() {
  # WhisperKit stores models in ~/Library/Caches/com.argmax.whisperkit/
  local model_dir="${HOME}/Library/Caches/com.argmax.whisperkit"
  if [[ -d "${model_dir}" ]] && find "${model_dir}" -name "*${MODEL}*" -type d 2>/dev/null | grep -q .; then
    return 0
  fi
  return 1
}

setup() {
  echo "=== Dictation Setup ==="
  echo

  echo "Checking dependencies..."
  if check_deps; then
    echo "  whisperkit-cli: OK"
    echo "  sox: OK"
  else
    echo
    echo "Install missing deps with: brew bundle --global"
    exit $EXIT_NOT_READY
  fi
  echo

  echo "Checking model (${MODEL})..."
  if check_model; then
    echo "  Model: OK"
  else
    echo "  Model not found. Downloading..."
    echo
    # First transcription triggers model download
    # Use a silent audio file to trigger it
    mkdir -p "${CACHE_DIR}"
    local tmp_wav="${CACHE_DIR}/setup-silence.wav"
    sox -n -r ${SAMPLE_RATE} -c 1 "${tmp_wav}" trim 0.0 1.0
    whisperkit-cli transcribe --audio-path "${tmp_wav}" --model "${MODEL}" || true
    rm -f "${tmp_wav}"

    if check_model; then
      echo "  Model: OK"
    else
      echo "  Model download may have failed. Try running again." >&2
      exit $EXIT_NOT_READY
    fi
  fi
  echo

  echo "Checking microphone access..."
  echo "  (Will prompt on first recording if needed)"
  echo

  mkdir -p "${CACHE_DIR}"

  echo "=== Setup complete ==="
  echo "Hold Fn to dictate (requires Hammerspoon config)"
}

check() {
  check_deps || exit $EXIT_NOT_READY
  check_model || exit $EXIT_NOT_READY
  exit $EXIT_SUCCESS
}

record_and_transcribe() {
  mkdir -p "${CACHE_DIR}"
  local audio_file="${CACHE_DIR}/recording-$$.wav"

  # Record from default mic until interrupted
  # Caller (Hammerspoon) sends SIGTERM/SIGINT to stop
  trap "cleanup '${audio_file}'" EXIT

  sox -d -r ${SAMPLE_RATE} -c 1 "${audio_file}" 2>/dev/null || {
    echo "Recording failed" >&2
    exit $EXIT_RECORDING_FAILED
  }

  # Check minimum duration
  local duration
  duration=$(sox "${audio_file}" -n stat 2>&1 | grep "Length" | awk '{print $3}')
  if (( $(echo "${duration} < ${MIN_DURATION}" | bc -l) )); then
    exit $EXIT_SUCCESS  # Too short, skip silently
  fi

  # Transcribe
  local result
  result=$(whisperkit-cli transcribe --audio-path "${audio_file}" --model "${MODEL}" 2>/dev/null) || {
    echo "Transcription failed" >&2
    exit $EXIT_TRANSCRIPTION_FAILED
  }

  # Output text only (strip any metadata)
  echo "${result}" | grep -v "^\\[" | tr -d '\n'
}

cleanup() {
  local file="$1"
  [[ -f "${file}" ]] && rm -f "${file}"
}

# Main
case "${1:-}" in
  --setup)
    setup
    ;;
  --check)
    check
    ;;
  --help|-h)
    usage
    ;;
  "")
    check_deps || exit $EXIT_NOT_READY
    record_and_transcribe
    ;;
  *)
    echo "Unknown option: $1" >&2
    usage >&2
    exit 1
    ;;
esac
