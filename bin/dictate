#!/usr/bin/env bash
# Local speech-to-text using whisper.cpp on Apple Silicon
# See: https://github.com/ansonhoyt/dotfiles/issues/1

set -euo pipefail

# Config
MODEL_NAME="ggml-large-v3-turbo-q5_0.bin"
MODEL_URL="https://huggingface.co/ggerganov/whisper.cpp/resolve/main/${MODEL_NAME}"
CACHE_DIR="${HOME}/.cache/dictate"
MODEL_DIR="${CACHE_DIR}/models"
MODEL_PATH="${MODEL_DIR}/${MODEL_NAME}"
SAMPLE_RATE=16000
MIN_DURATION=0.5

# Exit codes
EXIT_SUCCESS=0
EXIT_NOT_READY=1
EXIT_RECORDING_FAILED=2
EXIT_TRANSCRIPTION_FAILED=3

usage() {
  cat <<EOF
Usage: dictate [OPTIONS]

Local speech-to-text using whisper.cpp.

Options:
  --setup    Check deps, download model (interactive)
  --check    Quick deps check (exit 0 if ready, 1 if not)
  --help     Show this help

Without options: record from mic, transcribe, output to stdout.
EOF
}

check_deps() {
  local missing=()
  command -v whisper-cpp &>/dev/null || missing+=("whisper-cpp")
  command -v sox &>/dev/null || missing+=("sox")

  if [[ ${#missing[@]} -gt 0 ]]; then
    echo "Missing: ${missing[*]}" >&2
    echo "Run: brew bundle --global" >&2
    return 1
  fi
  return 0
}

check_model() {
  [[ -f "${MODEL_PATH}" ]]
}

download_model() {
  mkdir -p "${MODEL_DIR}"
  echo "Downloading ${MODEL_NAME}..."
  echo "  From: ${MODEL_URL}"
  echo "  To: ${MODEL_PATH}"
  echo
  curl -L --progress-bar -o "${MODEL_PATH}" "${MODEL_URL}"
}

setup() {
  echo "=== Dictation Setup ==="
  echo

  echo "Checking dependencies..."
  if check_deps; then
    echo "  whisper-cpp: OK"
    echo "  sox: OK"
  else
    echo
    echo "Install missing deps with: brew bundle --global"
    exit $EXIT_NOT_READY
  fi
  echo

  echo "Checking model (${MODEL_NAME})..."
  if check_model; then
    echo "  Model: OK (${MODEL_PATH})"
  else
    echo "  Model not found."
    echo
    download_model

    if check_model; then
      echo
      echo "  Model: OK"
    else
      echo "  Model download failed." >&2
      exit $EXIT_NOT_READY
    fi
  fi
  echo

  echo "Checking microphone access..."
  echo "  (Will prompt on first recording if needed)"
  echo

  mkdir -p "${CACHE_DIR}"

  echo "=== Setup complete ==="
  echo "Hold Fn to dictate (requires Hammerspoon config)"
}

check() {
  check_deps || exit $EXIT_NOT_READY
  check_model || exit $EXIT_NOT_READY
  exit $EXIT_SUCCESS
}

record_and_transcribe() {
  check_deps || exit $EXIT_NOT_READY
  check_model || {
    echo "Model not found. Run: dictate --setup" >&2
    exit $EXIT_NOT_READY
  }

  mkdir -p "${CACHE_DIR}"
  local audio_file="${CACHE_DIR}/recording-$$.wav"

  # Cleanup on exit
  trap "rm -f '${audio_file}'" EXIT

  # Record from default mic until interrupted (SIGTERM/SIGINT)
  sox -d -r ${SAMPLE_RATE} -c 1 "${audio_file}" 2>/dev/null || {
    # sox exits non-zero on interrupt, check if file exists
    if [[ ! -f "${audio_file}" ]]; then
      echo "Recording failed" >&2
      exit $EXIT_RECORDING_FAILED
    fi
  }

  # Check if file exists and has content
  if [[ ! -f "${audio_file}" ]] || [[ ! -s "${audio_file}" ]]; then
    exit $EXIT_SUCCESS  # No recording, exit silently
  fi

  # Check minimum duration
  local duration
  duration=$(sox "${audio_file}" -n stat 2>&1 | grep "Length" | awk '{print $3}' || echo "0")
  if (( $(echo "${duration} < ${MIN_DURATION}" | bc -l) )); then
    exit $EXIT_SUCCESS  # Too short, skip silently
  fi

  # Transcribe (suppress whisper-cpp stderr, output text only)
  local result
  result=$(whisper-cpp -m "${MODEL_PATH}" -f "${audio_file}" --no-timestamps -nt 2>/dev/null) || {
    echo "Transcription failed" >&2
    exit $EXIT_TRANSCRIPTION_FAILED
  }

  # Output trimmed text
  echo "${result}" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//'
}

# Main
case "${1:-}" in
  --setup)
    setup
    ;;
  --check)
    check
    ;;
  --help|-h)
    usage
    ;;
  "")
    record_and_transcribe
    ;;
  *)
    echo "Unknown option: $1" >&2
    usage >&2
    exit 1
    ;;
esac
