#!/usr/bin/env bash

# Given a package name, lists currently used package version across all projects.
#
# Displays the spec and currently installed version from yarn.lock for the named JS package.
#
# Usage: package-usage <package_name>

# Check if package name argument is provided
if [ $# -eq 0 ]; then
    echo "Usage: $0 <package-name>"
    echo "Example: $0 stimulus"
    echo "Example: $0 @hotwired/stimulus"
    exit 1
fi

NAME=$1

# Color output only when stdout is a TTY
if [ -t 1 ]; then
  COLOR="--color=always"
else
  COLOR="--color=never"
fi

colorize() {
  rg $COLOR --pcre2 --passthru \
    -e "${NAME}" \
    -e '(?<=version ")[^"]+(?=")'
}

# Look in the right code folder on my mac or the server.
if [ "$(uname)" == "Darwin" ]; then
  FOLDER=~/code
elif [ "$(expr substr $(uname -s) 1 5)" == "Linux" ]; then
  FOLDER=/export/home
else
  echo Unexpected OS: $(uname -s)
  exit 1
fi

# Example yarn.lock:
#   "@hotwired/stimulus@^3.2.1":
#     version "3.2.2"
#
# Example result:
#   ~/code/project1/yarn.lock: "@hotwired/stimulus@^3.2.1":   version "3.2.1"
#   ~/code/project2/yarn.lock: "@hotwired/stimulus@^3.2.1":   version "3.2.1"
rg --multiline --sort path --only-matching --no-line-number --with-filename \
  --glob 'yarn.lock' \
  --glob '!node_modules/' \
  --glob '!shared/' \
  --glob '!releases/' \
  "^\"?((?:@[\w-]+/)?${NAME}@[^\":\n]+)\"?:\n  version \"([^\"]+)\"" \
  --replace '$1 version "$2"' \
  "${FOLDER}" \
  | sed "s|${HOME}|~|" \
  | colorize

